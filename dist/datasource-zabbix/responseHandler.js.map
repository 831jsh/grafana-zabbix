{"version":3,"sources":["../../src/datasource-zabbix/responseHandler.js"],"names":["convertHistory","history","items","addHostName","convertPointCallback","grouped_history","_","groupBy","hosts","uniqBy","flatten","map","hist","itemid","item","find","alias","name","keys","length","host","hostid","target","datapoints","sortTimeseries","timeseries","forEach","series","sortBy","point","c","DATAPOINT_TS","handleHistory","convertHistoryPoint","handleTrends","valueType","partial","convertTrendPoint","handleText","convertTextCallback","convertText","handleHistoryAsTable","table","TableModel","addColumn","text","each","itemHistory","lastPoint","last","lastValue","value","options","skipEmptyValues","textFilter","extractText","useCaptureGroups","first","rows","push","key_","clock","Math","round","ns","str","pattern","extractPattern","RegExp","extractedValue","exec","handleSLAResponse","itservice","slaProperty","slaObject","targetSLA","serviceid","sla","property","targetStatus","parseInt","status","to","from","handleTriggersResponse","triggers","timeRange","isNumber","stats","getTriggerStats","orderBy","TRIGGER_SEVERITY","severity","severity_stats","group","row","toPairs","s","concat","groups","uniq","flattenDeep","trigger","priority","Number","value_min","value_max","value_avg","value_sum","value_count"],"mappings":"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","file":"responseHandler.js","sourcesContent":["import _ from 'lodash';\nimport TableModel from 'app/core/table_model';\nimport * as c from './constants';\n\n/**\n * Convert Zabbix API history.get response to Grafana format\n *\n * @return {Array}            Array of timeseries in Grafana format\n *                            {\n *                               target: \"Metric name\",\n *                               datapoints: [[<value>, <unixtime>], ...]\n *                            }\n */\nfunction convertHistory(history, items, addHostName, convertPointCallback) {\n  /**\n   * Response should be in the format:\n   * data: [\n   *          {\n   *             target: \"Metric name\",\n   *             datapoints: [[<value>, <unixtime>], ...]\n   *          }, ...\n   *       ]\n   */\n\n  // Group history by itemid\n  var grouped_history = _.groupBy(history, 'itemid');\n  var hosts = _.uniqBy(_.flatten(_.map(items, 'hosts')), 'hostid');  //uniqBy is needed to deduplicate\n\n  return _.map(grouped_history, function(hist, itemid) {\n    var item = _.find(items, {'itemid': itemid});\n    var alias = item.name;\n    if (_.keys(hosts).length > 1 && addHostName) {   //only when actual multi hosts selected\n      var host = _.find(hosts, {'hostid': item.hostid});\n      alias = host.name + \": \" + alias;\n    }\n    return {\n      target: alias,\n      datapoints: _.map(hist, convertPointCallback)\n    };\n  });\n}\n\nfunction sortTimeseries(timeseries) {\n  // Sort trend data, issue #202\n  _.forEach(timeseries, series => {\n    series.datapoints = _.sortBy(series.datapoints, point => point[c.DATAPOINT_TS]);\n  });\n  return timeseries;\n}\n\nfunction handleHistory(history, items, addHostName = true) {\n  return convertHistory(history, items, addHostName, convertHistoryPoint);\n}\n\nfunction handleTrends(history, items, valueType, addHostName = true) {\n  var convertPointCallback = _.partial(convertTrendPoint, valueType);\n  return convertHistory(history, items, addHostName, convertPointCallback);\n}\n\nfunction handleText(history, items, target, addHostName = true) {\n  let convertTextCallback = _.partial(convertText, target);\n  return convertHistory(history, items, addHostName, convertTextCallback);\n}\n\nfunction handleHistoryAsTable(history, items, target) {\n  let table = new TableModel();\n  table.addColumn({text: 'Host'});\n  table.addColumn({text: 'Item'});\n  table.addColumn({text: 'Key'});\n  table.addColumn({text: 'Last value'});\n\n  let grouped_history = _.groupBy(history, 'itemid');\n  _.each(items, (item) => {\n    let itemHistory = grouped_history[item.itemid] || [];\n    let lastPoint = _.last(itemHistory);\n    let lastValue = lastPoint ? lastPoint.value : null;\n\n    if(target.options.skipEmptyValues && (!lastValue || lastValue === '')) {\n      return;\n    }\n\n    // Regex-based extractor\n    if (target.textFilter) {\n      lastValue = extractText(lastValue, target.textFilter, target.useCaptureGroups);\n    }\n\n    let host = _.first(item.hosts);\n    host = host ? host.name : \"\";\n\n    table.rows.push([\n      host, item.name, item.key_, lastValue\n    ]);\n  });\n\n  return table;\n}\n\nfunction convertText(target, point) {\n  let value = point.value;\n\n  // Regex-based extractor\n  if (target.textFilter) {\n    value = extractText(point.value, target.textFilter, target.useCaptureGroups);\n  }\n\n  return [\n    value,\n    point.clock * 1000 + Math.round(point.ns / 1000000)\n  ];\n}\n\nfunction extractText(str, pattern, useCaptureGroups) {\n  let extractPattern = new RegExp(pattern);\n  let extractedValue = extractPattern.exec(str);\n  if (extractedValue) {\n    if (useCaptureGroups) {\n      extractedValue = extractedValue[1];\n    } else {\n      extractedValue = extractedValue[0];\n    }\n  }\n  return extractedValue;\n}\n\nfunction handleSLAResponse(itservice, slaProperty, slaObject) {\n  var targetSLA = slaObject[itservice.serviceid].sla[0];\n  if (slaProperty.property === 'status') {\n    var targetStatus = parseInt(slaObject[itservice.serviceid].status);\n    return {\n      target: itservice.name + ' ' + slaProperty.name,\n      datapoints: [\n        [targetStatus, targetSLA.to * 1000]\n      ]\n    };\n  } else {\n    return {\n      target: itservice.name + ' ' + slaProperty.name,\n      datapoints: [\n        [targetSLA[slaProperty.property], targetSLA.from * 1000],\n        [targetSLA[slaProperty.property], targetSLA.to * 1000]\n      ]\n    };\n  }\n}\n\nfunction handleTriggersResponse(triggers, timeRange) {\n  if (_.isNumber(triggers)) {\n    return {\n      target: \"triggers count\",\n      datapoints: [\n        [triggers, timeRange[1] * 1000]\n      ]\n    };\n  } else {\n    let stats = getTriggerStats(triggers);\n    let table = new TableModel();\n    table.addColumn({text: 'Host group'});\n    _.each(_.orderBy(c.TRIGGER_SEVERITY, ['val'], ['desc']), (severity) => {\n      table.addColumn({text: severity.text});\n    });\n    _.each(stats, (severity_stats, group) => {\n      let row = _.map(_.orderBy(_.toPairs(severity_stats), (s) => s[0], ['desc']), (s) => s[1]);\n      row = _.concat([group], ...row);\n      table.rows.push(row);\n    });\n    return table;\n  }\n}\n\nfunction getTriggerStats(triggers) {\n  let groups = _.uniq(_.flattenDeep(_.map(triggers, (trigger) => _.map(trigger.groups, 'name'))));\n  // let severity = _.map(c.TRIGGER_SEVERITY, 'text');\n  let stats = {};\n  _.each(groups, (group) => {\n    stats[group] = {0:0, 1:0, 2:0, 3:0, 4:0, 5:0}; // severity:count\n  });\n  _.each(triggers, (trigger) => {\n    _.each(trigger.groups, (group) => {\n      stats[group.name][trigger.priority]++;\n    });\n  });\n  return stats;\n}\n\nfunction convertHistoryPoint(point) {\n  // Value must be a number for properly work\n  return [\n    Number(point.value),\n    point.clock * 1000 + Math.round(point.ns / 1000000)\n  ];\n}\n\nfunction convertTrendPoint(valueType, point) {\n  var value;\n  switch (valueType) {\n    case \"min\":\n      value = point.value_min;\n      break;\n    case \"max\":\n      value = point.value_max;\n      break;\n    case \"avg\":\n      value = point.value_avg;\n      break;\n    case \"sum\":\n      value = point.value_sum;\n      break;\n    case \"count\":\n      value = point.value_count;\n      break;\n    default:\n      value = point.value_avg;\n  }\n\n  return [\n    Number(value),\n    point.clock * 1000\n  ];\n}\n\nexport default {\n  handleHistory,\n  convertHistory,\n  handleTrends,\n  handleText,\n  handleHistoryAsTable,\n  handleSLAResponse,\n  handleTriggersResponse,\n  sortTimeseries\n};\n\n// Fix for backward compatibility with lodash 2.4\nif (!_.uniqBy) {_.uniqBy = _.uniq;}\n"]}