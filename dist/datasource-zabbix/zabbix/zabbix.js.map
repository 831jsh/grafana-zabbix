{"version":3,"sources":["../../../src/datasource-zabbix/zabbix/zabbix.js"],"names":["findByName","list","name","finded","_","find","filterByName","filter","filterByRegex","regex","filterPattern","utils","buildRegex","zbx_obj","test","findByFilter","isRegex","filterByQuery","getHostIds","items","hostIds","map","item","hosts","uniq","flatten","ZabbixAPIConnector","ZabbixDBConnector","ZabbixCachingProxy","Zabbix","url","options","backendSrv","datasourceSrv","username","password","basicAuth","withCredentials","cacheTTL","enableDirectDBConnection","sqlDatasourceId","zabbixAPI","dbConnector","cacheOptions","enabled","ttl","cachingProxy","getHistory","bind","getMacros","getItemsByIDs","getHistoryDB","getTrendsDB","getTrend","getEvents","getAlerts","getHostAlerts","getAcknowledges","getITService","getSLA","getVersion","login","target","parts","filters","p","getItems","Promise","all","getHosts","getApps","then","results","apps","appFilterEmpty","getGroups","groupFilter","getAllGroups","groups","groupids","hostFilter","getAllHosts","hostids","appFilter","undefined","itemtype","appids","showDisabledItems","expandUserMacro","forEach","containsMacro","replaceMacro","macros","itemFilter","getAllItems","itServiceFilter","getITServices","itServices","promises","filteredGroups","filteredHosts","filteredApps","query","applicationids","getTriggers"],"mappings":"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","file":"zabbix.js","sourcesContent":["// import angular from 'angular';\nimport _ from 'lodash';\nimport * as utils from '../utils';\nimport { ZabbixAPIConnector } from './connectors/zabbix_api/zabbixAPIConnector';\nimport { ZabbixDBConnector } from './connectors/sql/zabbixDBConnector';\nimport { ZabbixCachingProxy } from './proxy/zabbixCachingProxy';\n\nexport class Zabbix {\n\n  /** @ngInject */\n  constructor(url, options, backendSrv, datasourceSrv) {\n    let {\n      username, password, basicAuth, withCredentials, cacheTTL,\n      enableDirectDBConnection, sqlDatasourceId\n    } = options;\n\n    // Initialize Zabbix API\n    this.zabbixAPI = new ZabbixAPIConnector(url, username, password, basicAuth, withCredentials, backendSrv);\n\n    if (enableDirectDBConnection) {\n      this.dbConnector = new ZabbixDBConnector(sqlDatasourceId, {}, backendSrv, datasourceSrv);\n    }\n\n    // Initialize caching proxy for requests\n    let cacheOptions = {\n      enabled: true,\n      ttl: cacheTTL\n    };\n    this.cachingProxy = new ZabbixCachingProxy(this.zabbixAPI, this.dbConnector, cacheOptions);\n\n    // Proxy methods\n    this.getHistory = this.cachingProxy.getHistory.bind(this.cachingProxy);\n    this.getMacros = this.cachingProxy.getMacros.bind(this.cachingProxy);\n    this.getItemsByIDs = this.cachingProxy.getItemsByIDs.bind(this.cachingProxy);\n\n    if (enableDirectDBConnection) {\n      this.getHistoryDB = this.cachingProxy.getHistoryDB.bind(this.cachingProxy);\n      this.getTrendsDB = this.cachingProxy.getTrendsDB.bind(this.cachingProxy);\n    }\n\n    this.getTrend = this.zabbixAPI.getTrend.bind(this.zabbixAPI);\n    this.getEvents = this.zabbixAPI.getEvents.bind(this.zabbixAPI);\n    this.getAlerts = this.zabbixAPI.getAlerts.bind(this.zabbixAPI);\n    this.getHostAlerts = this.zabbixAPI.getHostAlerts.bind(this.zabbixAPI);\n    this.getAcknowledges = this.zabbixAPI.getAcknowledges.bind(this.zabbixAPI);\n    this.getITService = this.zabbixAPI.getITService.bind(this.zabbixAPI);\n    this.getSLA = this.zabbixAPI.getSLA.bind(this.zabbixAPI);\n    this.getVersion = this.zabbixAPI.getVersion.bind(this.zabbixAPI);\n    this.login = this.zabbixAPI.login.bind(this.zabbixAPI);\n  }\n\n  getItemsFromTarget(target, options) {\n    let parts = ['group', 'host', 'application', 'item'];\n    let filters = _.map(parts, p => target[p].filter);\n    return this.getItems(...filters, options);\n  }\n\n  getHostsFromTarget(target) {\n    let parts = ['group', 'host', 'application'];\n    let filters = _.map(parts, p => target[p].filter);\n    return Promise.all([\n      this.getHosts(...filters),\n      this.getApps(...filters),\n    ]).then((results) => {\n      let [hosts, apps] = results;\n      if (apps.appFilterEmpty) {\n        apps = [];\n      }\n      return [hosts, apps];\n    });\n  }\n\n  getAllGroups() {\n    return this.cachingProxy.getGroups();\n  }\n\n  getGroups(groupFilter) {\n    return this.getAllGroups()\n    .then(groups => findByFilter(groups, groupFilter));\n  }\n\n  /**\n   * Get list of host belonging to given groups.\n   */\n  getAllHosts(groupFilter) {\n    return this.getGroups(groupFilter)\n    .then(groups => {\n      let groupids = _.map(groups, 'groupid');\n      return this.cachingProxy.getHosts(groupids);\n    });\n  }\n\n  getHosts(groupFilter, hostFilter) {\n    return this.getAllHosts(groupFilter)\n    .then(hosts => findByFilter(hosts, hostFilter));\n  }\n\n  /**\n   * Get list of applications belonging to given groups and hosts.\n   */\n  getAllApps(groupFilter, hostFilter) {\n    return this.getHosts(groupFilter, hostFilter)\n    .then(hosts => {\n      let hostids = _.map(hosts, 'hostid');\n      return this.cachingProxy.getApps(hostids);\n    });\n  }\n\n  getApps(groupFilter, hostFilter, appFilter) {\n    return this.getHosts(groupFilter, hostFilter)\n    .then(hosts => {\n      let hostids = _.map(hosts, 'hostid');\n      if (appFilter) {\n        return this.cachingProxy.getApps(hostids)\n        .then(apps => filterByQuery(apps, appFilter));\n      } else {\n        return {\n          appFilterEmpty: true,\n          hostids: hostids\n        };\n      }\n    });\n  }\n\n  getAllItems(groupFilter, hostFilter, appFilter, options = {}) {\n    return this.getApps(groupFilter, hostFilter, appFilter)\n    .then(apps => {\n      if (apps.appFilterEmpty) {\n        return this.cachingProxy.getItems(apps.hostids, undefined, options.itemtype);\n      } else {\n        let appids = _.map(apps, 'applicationid');\n        return this.cachingProxy.getItems(undefined, appids, options.itemtype);\n      }\n    })\n    .then(items => {\n      if (!options.showDisabledItems) {\n        items = _.filter(items, {'status': '0'});\n      }\n\n      return items;\n    })\n    .then(this.expandUserMacro.bind(this));\n  }\n\n  expandUserMacro(items) {\n    let hostids = getHostIds(items);\n    return this.getMacros(hostids)\n    .then(macros => {\n      _.forEach(items, item => {\n        if (utils.containsMacro(item.name)) {\n          item.name = utils.replaceMacro(item, macros);\n        }\n      });\n      return items;\n    });\n  }\n\n  getItems(groupFilter, hostFilter, appFilter, itemFilter, options = {}) {\n    return this.getAllItems(groupFilter, hostFilter, appFilter, options)\n    .then(items => filterByQuery(items, itemFilter));\n  }\n\n  getITServices(itServiceFilter) {\n    return this.cachingProxy.getITServices()\n    .then(itServices => findByFilter(itServices, itServiceFilter));\n  }\n\n  /**\n   * Build query - convert target filters to array of Zabbix items\n   */\n  getTriggers(groupFilter, hostFilter, appFilter, options) {\n    let promises = [\n      this.getGroups(groupFilter),\n      this.getHosts(groupFilter, hostFilter),\n      this.getApps(groupFilter, hostFilter, appFilter)\n    ];\n\n    return Promise.all(promises)\n    .then(results => {\n      let filteredGroups = results[0];\n      let filteredHosts = results[1];\n      let filteredApps = results[2];\n      let query = {};\n\n      if (appFilter) {\n        query.applicationids = _.flatten(_.map(filteredApps, 'applicationid'));\n      }\n      if (hostFilter) {\n        query.hostids = _.map(filteredHosts, 'hostid');\n      }\n      if (groupFilter) {\n        query.groupids = _.map(filteredGroups, 'groupid');\n      }\n\n      return query;\n    }).then(query => {\n      return this.zabbixAPI.getTriggers(query.groupids, query.hostids, query.applicationids, options);\n    });\n  }\n}\n\n// angular\n//   .module('grafana.services')\n//   .factory('Zabbix', ZabbixFactory);\n\n///////////////////////////////////////////////////////////////////////////////\n\n/**\n * Find group, host, app or item by given name.\n * @param  list list of groups, apps or other\n * @param  name visible name\n * @return      array with finded element or empty array\n */\nfunction findByName(list, name) {\n  var finded = _.find(list, {'name': name});\n  if (finded) {\n    return [finded];\n  } else {\n    return [];\n  }\n}\n\n/**\n * Different hosts can contains applications and items with same name.\n * For this reason use _.filter, which return all elements instead _.find,\n * which return only first finded.\n * @param  {[type]} list list of elements\n * @param  {[type]} name app name\n * @return {[type]}      array with finded element or empty array\n */\nfunction filterByName(list, name) {\n  var finded = _.filter(list, {'name': name});\n  if (finded) {\n    return finded;\n  } else {\n    return [];\n  }\n}\n\nfunction filterByRegex(list, regex) {\n  var filterPattern = utils.buildRegex(regex);\n  return _.filter(list, function (zbx_obj) {\n    return filterPattern.test(zbx_obj.name);\n  });\n}\n\nfunction findByFilter(list, filter) {\n  if (utils.isRegex(filter)) {\n    return filterByRegex(list, filter);\n  } else {\n    return findByName(list, filter);\n  }\n}\n\nfunction filterByQuery(list, filter) {\n  if (utils.isRegex(filter)) {\n    return filterByRegex(list, filter);\n  } else {\n    return filterByName(list, filter);\n  }\n}\n\nfunction getHostIds(items) {\n  let hostIds = _.map(items, item => {\n    return _.map(item.hosts, 'hostid');\n  });\n  return _.uniq(_.flatten(hostIds));\n}\n"]}