{"version":3,"sources":["../../../../src/datasource-zabbix/zabbix/proxy/zabbixCachingProxy.js"],"names":["callAPIRequestOnce","func","promiseKeeper","argsHashFunc","hash","arguments","Promise","resolve","apply","then","result","getRequestHash","args","requestStamp","_","map","arg","undefined","isArray","sort","toString","join","getHash","getHistoryRequestHash","itemids","stamp","getDBQueryHash","consolidateBy","intervalMs","ZabbixCachingProxy","zabbixAPI","zabbixDBConnector","cacheOptions","dbConnector","cacheEnabled","enabled","ttl","cache","groups","hosts","applications","items","history","trends","macros","globalMacros","itServices","historyPromises","getHistory","bind","getHistoryDB","getTrendsDB","getTrends","groupPromises","getGroupsOnce","getGroups","hostPromises","getHostsOnce","getHosts","appPromises","getAppsOnce","getApps","itemPromises","getItemsOnce","getItems","itemByIdPromises","getItemsByIdOnce","getItemsByIDs","itServicesPromises","getITServicesOnce","getITService","macroPromises","getMacrosOnce","getMacros","globalMacroPromises","getGlobalMacrosOnce","getGlobalMacros","cacheObject","object_age","Date","now","timestamp","request","params","isExpired","value","proxyRequest","groupids","hostids","appids","itemtype","promises","all","flatten","time_from","time_till","historyStorage","full_history","expired","filter","keyBy","item","itemid","length","grouped_history","groupBy","forEach","String","prototype","i","chr","len","charCodeAt","indexBy"],"mappings":"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","file":"zabbixCachingProxy.js","sourcesContent":["import _ from 'lodash';\n\nexport class ZabbixCachingProxy {\n  constructor(zabbixAPI, zabbixDBConnector, cacheOptions) {\n    this.zabbixAPI = zabbixAPI;\n    this.dbConnector = zabbixDBConnector;\n    this.cacheEnabled = cacheOptions.enabled;\n    this.ttl          = cacheOptions.ttl || 600000; // 10 minutes by default\n\n    // Internal objects for data storing\n    this.cache = {\n      groups: {},\n      hosts: {},\n      applications: {},\n      items: {},\n      history: {},\n      trends: {},\n      macros: {},\n      globalMacros: {},\n      itServices: {}\n    };\n\n    this.historyPromises = {};\n\n    // Don't run duplicated history requests\n    this.getHistory = callAPIRequestOnce(_.bind(this.zabbixAPI.getHistory, this.zabbixAPI),\n                                          this.historyPromises, getHistoryRequestHash);\n\n    if (this.dbConnector) {\n      this.getHistoryDB = callAPIRequestOnce(_.bind(this.dbConnector.getHistory, this.dbConnector),\n                                              this.historyPromises, getDBQueryHash);\n      this.getTrendsDB = callAPIRequestOnce(_.bind(this.dbConnector.getTrends, this.dbConnector),\n                                            this.historyPromises, getDBQueryHash);\n    }\n\n    // Don't run duplicated requests\n    this.groupPromises = {};\n    this.getGroupsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGroups, this.zabbixAPI),\n                                            this.groupPromises, getRequestHash);\n\n    this.hostPromises = {};\n    this.getHostsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getHosts, this.zabbixAPI),\n                                            this.hostPromises, getRequestHash);\n\n    this.appPromises = {};\n    this.getAppsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getApps, this.zabbixAPI),\n                                          this.appPromises, getRequestHash);\n\n    this.itemPromises = {};\n    this.getItemsOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItems, this.zabbixAPI),\n                                            this.itemPromises, getRequestHash);\n\n    this.itemByIdPromises = {};\n    this.getItemsByIdOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getItemsByIDs, this.zabbixAPI),\n                                                this.itemPromises, getRequestHash);\n\n    this.itServicesPromises = {};\n    this.getITServicesOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getITService, this.zabbixAPI),\n                                                this.itServicesPromises, getRequestHash);\n\n    this.macroPromises = {};\n    this.getMacrosOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getMacros, this.zabbixAPI),\n                                            this.macroPromises, getRequestHash);\n\n    this.globalMacroPromises = {};\n    this.getGlobalMacrosOnce = callAPIRequestOnce(_.bind(this.zabbixAPI.getGlobalMacros, this.zabbixAPI),\n                                                  this.globalMacroPromises, getRequestHash);\n  }\n\n  isExpired(cacheObject) {\n    if (cacheObject) {\n      let object_age = Date.now() - cacheObject.timestamp;\n      return !(cacheObject.timestamp && object_age < this.ttl);\n    } else {\n      return true;\n    }\n  }\n\n  /**\n   * Check that result is present in cache and up to date\n   * or send request to API.\n   */\n  proxyRequest(request, params, cacheObject) {\n    let hash = getRequestHash(params);\n    if (this.cacheEnabled && !this.isExpired(cacheObject[hash])) {\n      return Promise.resolve(cacheObject[hash].value);\n    } else {\n      return request(...params)\n      .then(result => {\n        cacheObject[hash] = {\n          value: result,\n          timestamp: Date.now()\n        };\n        return result;\n      });\n    }\n  }\n\n  getGroups() {\n    return this.proxyRequest(this.getGroupsOnce, [], this.cache.groups);\n  }\n\n  getHosts(groupids) {\n    return this.proxyRequest(this.getHostsOnce, [groupids], this.cache.hosts);\n  }\n\n  getApps(hostids) {\n    return this.proxyRequest(this.getAppsOnce, [hostids], this.cache.applications);\n  }\n\n  getItems(hostids, appids, itemtype) {\n    let params = [hostids, appids, itemtype];\n    return this.proxyRequest(this.getItemsOnce, params, this.cache.items);\n  }\n\n  getItemsByIDs(itemids) {\n    let params = [itemids];\n    return this.proxyRequest(this.getItemsByIdOnce, params, this.cache.items);\n  }\n\n  getITServices() {\n    return this.proxyRequest(this.getITServicesOnce, [], this.cache.itServices);\n  }\n\n  getMacros(hostids) {\n    // Merge global macros and host macros\n    let promises = [\n      this.proxyRequest(this.getMacrosOnce, [hostids], this.cache.macros),\n      this.proxyRequest(this.getGlobalMacrosOnce, [], this.cache.globalMacros)\n    ];\n\n    return Promise.all(promises).then(_.flatten);\n  }\n\n  getHistoryFromCache(items, time_from, time_till) {\n    var historyStorage = this.cache.history;\n    var full_history;\n    var expired = _.filter(_.keyBy(items, 'itemid'), (item, itemid) => {\n      return !historyStorage[itemid];\n    });\n    if (expired.length) {\n      return this.zabbixAPI.getHistory(expired, time_from, time_till).then(function(history) {\n        var grouped_history = _.groupBy(history, 'itemid');\n        _.forEach(expired, item => {\n          var itemid = item.itemid;\n          historyStorage[itemid] = item;\n          historyStorage[itemid].time_from = time_from;\n          historyStorage[itemid].time_till = time_till;\n          historyStorage[itemid].history = grouped_history[itemid];\n        });\n        full_history = _.map(items, item => {\n          return historyStorage[item.itemid].history;\n        });\n        return _.flatten(full_history, true);\n      });\n    } else {\n      full_history = _.map(items, function(item) {\n        return historyStorage[item.itemid].history;\n      });\n      return Promise.resolve(_.flatten(full_history, true));\n    }\n  }\n\n  getHistoryFromAPI(items, time_from, time_till) {\n    return this.zabbixAPI.getHistory(items, time_from, time_till);\n  }\n}\n\n/**\n * Wrap zabbix API request to prevent multiple calls\n * with same params when waiting for result.\n */\nfunction callAPIRequestOnce(func, promiseKeeper, argsHashFunc) {\n  return function() {\n    var hash = argsHashFunc(arguments);\n    if (!promiseKeeper[hash]) {\n      promiseKeeper[hash] = Promise.resolve(\n        func.apply(this, arguments)\n        .then(result => {\n          promiseKeeper[hash] = null;\n          return result;\n        })\n      );\n    }\n    return promiseKeeper[hash];\n  };\n}\n\nfunction getRequestHash(args) {\n  var requestStamp = _.map(args, arg => {\n    if (arg === undefined) {\n      return 'undefined';\n    } else {\n      if (_.isArray(arg)) {\n        return arg.sort().toString();\n      } else {\n        return arg.toString();\n      }\n    }\n  }).join();\n  return requestStamp.getHash();\n}\n\nfunction getHistoryRequestHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let stamp = itemids.join() + args[1] + args[2];\n  return stamp.getHash();\n}\n\nfunction getDBQueryHash(args) {\n  let itemids = _.map(args[0], 'itemid');\n  let consolidateBy = args[3].consolidateBy;\n  let intervalMs = args[3].intervalMs;\n  let stamp = itemids.join() + args[1] + args[2] + consolidateBy + intervalMs;\n  return stamp.getHash();\n}\n\nString.prototype.getHash = function() {\n  var hash = 0, i, chr, len;\n  if (this.length !== 0) {\n    for (i = 0, len = this.length; i < len; i++) {\n      chr   = this.charCodeAt(i);\n      hash  = ((hash << 5) - hash) + chr;\n      hash |= 0; // Convert to 32bit integer\n    }\n  }\n  return hash;\n};\n\n// Fix for backward compatibility with lodash 2.4\nif (!_.keyBy) {_.keyBy = _.indexBy;}\n"]}