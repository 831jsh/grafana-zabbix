{"version":3,"sources":["../../../src/datasource-zabbix/specs/datasource.spec.js"],"names":["_","Datasource","zabbixTemplateFormat","describe","ctx","beforeEach","instanceSettings","jsonData","alerting","username","password","trends","trendsFrom","trendsRange","dbConnectionEnable","templateSrv","backendSrv","datasourceRequest","jest","fn","datasourceSrv","zabbixAlertingSrv","setPanelAlertState","removeZabbixThreshold","ds","replaceTemplateVars","str","options","targets","group","filter","host","application","item","range","from","to","it","done","query","then","expect","result","data","length","toBe","ranges","forEach","queryNumericData","callArgs","mock","calls","mockClear","zabbix","zabbixAPI","getHistory","mockReturnValue","Promise","resolve","clock","itemid","ns","value","getItemsFromTarget","hosts","hostid","name","key_","textFilter","useCaptureGroups","mode","resultFormat","skipEmptyValues","tableData","columns","toEqual","text","rows","testReplacingVariable","target","varValue","expectedResult","replace","template_var_value","expected_result","getGroups","getHosts","getApps","getItems","tests","test","metricFindQuery","toBeCalledWith","targetItems","itemTriggers","getAlerts","alertQuery","resp","thresholds","toHaveLength"],"mappings":";;;;;;;;;AAAOA,O;;AACEC,gB,WAAAA,U;;AACAC,0B,eAAAA,oB;;;;AAETC,eAAS,kBAAT,EAA6B,YAAM;AACjC,YAAIC,MAAM,EAAV;;AAEAC,mBAAW,YAAM;AACfD,cAAIE,gBAAJ,GAAuB;AACrBC,sBAAU;AACRC,wBAAU,KADF;AAERC,wBAAU,QAFF;AAGRC,wBAAU,QAHF;AAIRC,sBAAQ,IAJA;AAKRC,0BAAY,KALJ;AAMRC,2BAAa,IANL;AAORC,kCAAoB;AAPZ;AADW,WAAvB;AAWAV,cAAIW,WAAJ,GAAkB,EAAlB;AACAX,cAAIY,UAAJ,GAAiB;AACfC,+BAAmBC,KAAKC,EAAL;AADJ,WAAjB;AAGAf,cAAIgB,aAAJ,GAAoB,EAApB;AACAhB,cAAIiB,iBAAJ,GAAwB;AACtBC,gCAAoBJ,KAAKC,EAAL,EADE;AAEtBI,mCAAuBL,KAAKC,EAAL;AAFD,WAAxB;;AAKAf,cAAIoB,EAAJ,GAAS,IAAIvB,UAAJ,CAAeG,IAAIE,gBAAnB,EAAqCF,IAAIW,WAAzC,EAAsDX,IAAIY,UAA1D,EAAsEZ,IAAIgB,aAA1E,EAAyFhB,IAAIiB,iBAA7F,CAAT;AACD,SAvBD;;AAyBAlB,iBAAS,oBAAT,EAA+B,YAAM;AACnCE,qBAAW,YAAM;AACfD,gBAAIoB,EAAJ,CAAOC,mBAAP,GAA6B,UAACC,GAAD;AAAA,qBAASA,GAAT;AAAA,aAA7B;AACD,WAFD;;AAIAtB,cAAIuB,OAAJ,GAAc;AACZC,qBAAS,CACP;AACEC,qBAAO,EAACC,QAAQ,EAAT,EADT;AAEEC,oBAAM,EAACD,QAAQ,EAAT,EAFR;AAGEE,2BAAa,EAACF,QAAQ,EAAT,EAHf;AAIEG,oBAAM,EAACH,QAAQ,EAAT;AAJR,aADO,CADG;AASZI,mBAAO,EAACC,MAAM,QAAP,EAAiBC,IAAI,KAArB;AATK,WAAd;;AAYAC,aAAG,sDAAH,EAA2D,UAACC,IAAD,EAAU;AACnE,gBAAIX,UAAU;AACZC,uBAAS,EADG;AAEZM,qBAAO,EAACC,MAAM,QAAP,EAAiBC,IAAI,KAArB;AAFK,aAAd;AAIAhC,gBAAIoB,EAAJ,CAAOe,KAAP,CAAaZ,OAAb,EAAsBa,IAAtB,CAA2B,kBAAU;AACnCC,qBAAOC,OAAOC,IAAP,CAAYC,MAAnB,EAA2BC,IAA3B,CAAgC,CAAhC;AACAP;AACD,aAHD;AAID,WATD;;AAWAD,aAAG,+DAAH,EAAoE,UAACC,IAAD,EAAU;AAC5E,gBAAIQ,SAAS,CAAC,QAAD,EAAW,UAAX,EAAuB,QAAvB,EAAiC,QAAjC,CAAb;;AAEA9C,cAAE+C,OAAF,CAAUD,MAAV,EAAkB,iBAAS;AACzB1C,kBAAIuB,OAAJ,CAAYO,KAAZ,CAAkBC,IAAlB,GAAyBD,KAAzB;AACA9B,kBAAIoB,EAAJ,CAAOwB,gBAAP,GAA0B9B,KAAKC,EAAL,EAA1B;AACAf,kBAAIoB,EAAJ,CAAOe,KAAP,CAAanC,IAAIuB,OAAjB;;AAEA;AACA,kBAAIsB,WAAW7C,IAAIoB,EAAJ,CAAOwB,gBAAP,CAAwBE,IAAxB,CAA6BC,KAA7B,CAAmC,CAAnC,CAAf;AACAV,qBAAOQ,SAAS,CAAT,CAAP,EAAoBJ,IAApB,CAAyB,IAAzB;AACAzC,kBAAIoB,EAAJ,CAAOwB,gBAAP,CAAwBI,SAAxB;AACD,aATD;;AAWAd;AACD,WAfD;;AAiBAD,aAAG,iEAAH,EAAsE,UAACC,IAAD,EAAU;AAC9E,gBAAIQ,SAAS,CAAC,QAAD,EAAW,UAAX,EAAuB,QAAvB,EAAiC,SAAjC,EAA4C,SAA5C,CAAb;;AAEA9C,cAAE+C,OAAF,CAAUD,MAAV,EAAkB,iBAAS;AACzB1C,kBAAIuB,OAAJ,CAAYO,KAAZ,CAAkBC,IAAlB,GAAyBD,KAAzB;AACA9B,kBAAIoB,EAAJ,CAAOwB,gBAAP,GAA0B9B,KAAKC,EAAL,EAA1B;AACAf,kBAAIoB,EAAJ,CAAOe,KAAP,CAAanC,IAAIuB,OAAjB;;AAEA;AACA,kBAAIsB,WAAW7C,IAAIoB,EAAJ,CAAOwB,gBAAP,CAAwBE,IAAxB,CAA6BC,KAA7B,CAAmC,CAAnC,CAAf;AACAV,qBAAOQ,SAAS,CAAT,CAAP,EAAoBJ,IAApB,CAAyB,KAAzB;AACAzC,kBAAIoB,EAAJ,CAAOwB,gBAAP,CAAwBI,SAAxB;AACD,aATD;AAUAd;AACD,WAdD;AAgBD,SA7DD;;AA+DAnC,iBAAS,yBAAT,EAAoC,YAAM;AACxCE,qBAAW,YAAM;AACfD,gBAAIoB,EAAJ,CAAOC,mBAAP,GAA6B,UAACC,GAAD;AAAA,qBAASA,GAAT;AAAA,aAA7B;AACAtB,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAcC,SAAd,CAAwBC,UAAxB,GAAqCrC,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,CAC7E,EAACC,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,aAA5D,EAD6E,EAE7E,EAACH,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,WAA5D,EAF6E,EAG7E,EAACH,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,YAA5D,EAH6E,CAAhB,CAA1B,CAArC;;AAMA1D,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAcU,kBAAd,GAAmC7C,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,CAC3E;AACEM,qBAAO,CAAC,EAACC,QAAQ,OAAT,EAAkBC,MAAM,eAAxB,EAAD,CADT;AAEEN,sBAAQ,OAFV;AAGEM,oBAAM,oBAHR;AAIEC,oBAAM;AAJR,aAD2E,CAAhB,CAA1B,CAAnC;;AASA/D,gBAAIuB,OAAJ,GAAc;AACZO,qBAAO,EAACC,MAAM,QAAP,EAAiBC,IAAI,KAArB,EADK;AAEZR,uBAAS,CACP;AACEC,uBAAO,EAACC,QAAQ,EAAT,EADT;AAEEC,sBAAM,EAACD,QAAQ,eAAT,EAFR;AAGEE,6BAAa,EAACF,QAAQ,EAAT,EAHf;AAIEG,sBAAM,EAACH,QAAQ,oBAAT,EAJR;AAKEsC,4BAAY,EALd;AAMEC,kCAAkB,IANpB;AAOEC,sBAAM,CAPR;AAQEC,8BAAc,OARhB;AASE5C,yBAAS;AACP6C,mCAAiB;AADV;AATX,eADO;AAFG,aAAd;AAkBD,WAnCD;;AAqCAnC,aAAG,oCAAH,EAAyC,UAACC,IAAD,EAAU;AACjDlC,gBAAIoB,EAAJ,CAAOe,KAAP,CAAanC,IAAIuB,OAAjB,EAA0Ba,IAA1B,CAA+B,kBAAU;AACvCC,qBAAOC,OAAOC,IAAP,CAAYC,MAAnB,EAA2BC,IAA3B,CAAgC,CAAhC;;AAEA,kBAAI4B,YAAY/B,OAAOC,IAAP,CAAY,CAAZ,CAAhB;AACAF,qBAAOgC,UAAUC,OAAjB,EAA0BC,OAA1B,CAAkC,CAChC,EAACC,MAAM,MAAP,EADgC,EAChB,EAACA,MAAM,MAAP,EADgB,EACA,EAACA,MAAM,KAAP,EADA,EACe,EAACA,MAAM,YAAP,EADf,CAAlC;AAGAnC,qBAAOgC,UAAUI,IAAjB,EAAuBF,OAAvB,CAA+B,CAC7B,CAAC,eAAD,EAAkB,oBAAlB,EAAwC,cAAxC,EAAwD,YAAxD,CAD6B,CAA/B;AAGArC;AACD,aAXD;AAYD,WAbD;;AAeAD,aAAG,0DAAH,EAA+D,UAACC,IAAD,EAAU;AACvElC,gBAAIuB,OAAJ,CAAYC,OAAZ,CAAoB,CAApB,EAAuBwC,UAAvB,GAAoC,YAApC;AACAhE,gBAAIoB,EAAJ,CAAOe,KAAP,CAAanC,IAAIuB,OAAjB,EAA0Ba,IAA1B,CAA+B,kBAAU;AACvC,kBAAIiC,YAAY/B,OAAOC,IAAP,CAAY,CAAZ,CAAhB;AACAF,qBAAOgC,UAAUI,IAAV,CAAe,CAAf,EAAkB,CAAlB,CAAP,EAA6BF,OAA7B,CAAqC,MAArC;AACArC;AACD,aAJD;AAKD,WAPD;;AASAD,aAAG,2CAAH,EAAgD,YAAM;AACpDjC,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAcU,kBAAd,GAAmC7C,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,CAC3E;AACEM,qBAAO,CAAC,EAACC,QAAQ,OAAT,EAAkBC,MAAM,eAAxB,EAAD,CADT;AAEEN,sBAAQ,OAFV,EAEmBM,MAAM,oBAFzB,EAE+CC,MAAM;AAFrD,aAD2E,EAK3E;AACEH,qBAAO,CAAC,EAACC,QAAQ,OAAT,EAAkBC,MAAM,UAAxB,EAAD,CADT;AAEEN,sBAAQ,OAFV,EAEmBM,MAAM,oBAFzB,EAE+CC,MAAM;AAFrD,aAL2E,CAAhB,CAA1B,CAAnC;;AAWA/D,gBAAIuB,OAAJ,CAAYC,OAAZ,CAAoB,CAApB,EAAuBD,OAAvB,CAA+B6C,eAA/B,GAAiD,IAAjD;AACApE,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAcE,UAAd,GAA2BrC,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,CACjE,EAACC,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,aAA5D,EADiE,EAEjE,EAACH,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,WAA5D,EAFiE,EAGjE,EAACH,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,YAA5D,EAHiE,EAIjE,EAACH,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,iBAA5D,EAJiE,EAKjE,EAACH,OAAO,YAAR,EAAsBC,QAAO,OAA7B,EAAsCC,IAAG,WAAzC,EAAsDC,OAAM,EAA5D,EALiE,CAAhB,CAA1B,CAA3B;AAOA,mBAAO1D,IAAIoB,EAAJ,CAAOe,KAAP,CAAanC,IAAIuB,OAAjB,EAA0Ba,IAA1B,CAA+B,kBAAU;AAC9C,kBAAIiC,YAAY/B,OAAOC,IAAP,CAAY,CAAZ,CAAhB;AACAF,qBAAOgC,UAAUI,IAAV,CAAejC,MAAtB,EAA8BC,IAA9B,CAAmC,CAAnC;AACAJ,qBAAOgC,UAAUI,IAAV,CAAe,CAAf,EAAkB,CAAlB,CAAP,EAA6BF,OAA7B,CAAqC,YAArC;AACD,aAJM,CAAP;AAKD,WAzBD;AA0BD,SAxFD;;AA0FAxE,iBAAS,mCAAT,EAA8C,YAAM;;AAElD,mBAAS2E,qBAAT,CAA+BC,MAA/B,EAAuCC,QAAvC,EAAiDC,cAAjD,EAAiE3C,IAAjE,EAAuE;AACrElC,gBAAIoB,EAAJ,CAAOT,WAAP,CAAmBmE,OAAnB,GAA6B,YAAM;AACjC,qBAAOhF,qBAAqB8E,QAArB,CAAP;AACD,aAFD;;AAIA,gBAAItC,SAAStC,IAAIoB,EAAJ,CAAOC,mBAAP,CAA2BsD,MAA3B,CAAb;AACAtC,mBAAOC,MAAP,EAAeG,IAAf,CAAoBoC,cAApB;AACA3C;AACD;;AAED;;;;;AAKAD,aAAG,sCAAH,EAA2C,UAACC,IAAD,EAAU;AACnD,gBAAIyC,SAAS,OAAb;AACA,gBAAII,qBAAqB,gBAAzB;AACA,gBAAIC,kBAAkB,sBAAtB;;AAEAN,kCAAsBC,MAAtB,EAA8BI,kBAA9B,EAAkDC,eAAlD,EAAmE9C,IAAnE;AACD,WAND;;AAQA;;;;;AAKAD,aAAG,6CAAH,EAAkD,UAACC,IAAD,EAAU;AAC1D,gBAAIyC,SAAS,OAAb;AACA,gBAAII,qBAAqB,WAAzB;AACA,gBAAIC,kBAAkB,eAAtB;;AAEAN,kCAAsBC,MAAtB,EAA8BI,kBAA9B,EAAkDC,eAAlD,EAAmE9C,IAAnE;AACD,WAND;;AAQA;;;;;AAKAD,aAAG,4CAAH,EAAiD,UAACC,IAAD,EAAU;AACzD,gBAAIyC,SAAS,OAAb;AACA,gBAAII,qBAAqB,CAAC,WAAD,EAAc,WAAd,CAAzB;AACA,gBAAIC,kBAAkB,2BAAtB;;AAEAN,kCAAsBC,MAAtB,EAA8BI,kBAA9B,EAAkDC,eAAlD,EAAmE9C,IAAnE;AACD,WAND;AAOD,SAlDD;;AAoDAnC,iBAAS,iCAAT,EAA4C,YAAM;AAChDE,qBAAW,YAAM;AACfD,gBAAIoB,EAAJ,CAAOC,mBAAP,GAA6B,UAACC,GAAD;AAAA,qBAASA,GAAT;AAAA,aAA7B;AACAtB,gBAAIoB,EAAJ,CAAO6B,MAAP,GAAgB;AACdgC,yBAAWnE,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,EAAhB,CAA1B,CADG;AAEd4B,wBAAUpE,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,EAAhB,CAA1B,CAFI;AAGd6B,uBAASrE,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,EAAhB,CAA1B,CAHK;AAId8B,wBAAUtE,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgB,EAAhB,CAA1B;AAJI,aAAhB;AAMD,WARD;;AAUArB,aAAG,sBAAH,EAA2B,UAACC,IAAD,EAAU;AACnC,gBAAMmD,QAAQ,CACZ,EAAClD,OAAO,GAAR,EAAoBE,QAAQ,MAA5B,EADY,EAEZ,EAACF,OAAO,EAAR,EAAoBE,QAAQ,EAA5B,EAFY,EAGZ,EAACF,OAAO,SAAR,EAAoBE,QAAQ,SAA5B,EAHY,EAIZ,EAACF,OAAO,OAAR,EAAoBE,QAAQ,OAA5B,EAJY,CAAd;;AADmC;AAAA;AAAA;;AAAA;AAQnC,mCAAmBgD,KAAnB,8HAA0B;AAAA,oBAAfC,IAAe;;AACxBtF,oBAAIoB,EAAJ,CAAOmE,eAAP,CAAuBD,KAAKnD,KAA5B;AACAE,uBAAOrC,IAAIoB,EAAJ,CAAO6B,MAAP,CAAcgC,SAArB,EAAgCO,cAAhC,CAA+CF,KAAKjD,MAApD;AACArC,oBAAIoB,EAAJ,CAAO6B,MAAP,CAAcgC,SAAd,CAAwBjC,SAAxB;AACD;AAZkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAanCd;AACD,WAdD;;AAgBAD,aAAG,qBAAH,EAA0B,UAACC,IAAD,EAAU;AAClC,gBAAMmD,QAAQ,CACZ,EAAClD,OAAO,KAAR,EAAqBE,QAAQ,CAAC,MAAD,EAAS,MAAT,CAA7B,EADY,EAEZ,EAACF,OAAO,GAAR,EAAqBE,QAAQ,CAAC,EAAD,EAAK,EAAL,CAA7B,EAFY,EAGZ,EAACF,OAAO,WAAR,EAAqBE,QAAQ,CAAC,SAAD,EAAY,MAAZ,CAA7B,EAHY,EAIZ,EAACF,OAAO,QAAR,EAAqBE,QAAQ,CAAC,OAAD,EAAU,EAAV,CAA7B,EAJY,CAAd;;AADkC;AAAA;AAAA;;AAAA;AAQlC,oCAAmBgD,KAAnB,mIAA0B;AAAA,oBAAfC,IAAe;;AACxBtF,oBAAIoB,EAAJ,CAAOmE,eAAP,CAAuBD,KAAKnD,KAA5B;AACAE,uBAAOrC,IAAIoB,EAAJ,CAAO6B,MAAP,CAAciC,QAArB,EAA+BM,cAA/B,CAA8CF,KAAKjD,MAAL,CAAY,CAAZ,CAA9C,EAA8DiD,KAAKjD,MAAL,CAAY,CAAZ,CAA9D;AACArC,oBAAIoB,EAAJ,CAAO6B,MAAP,CAAciC,QAAd,CAAuBlC,SAAvB;AACD;AAZiC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAalCd;AACD,WAdD;;AAgBAD,aAAG,4BAAH,EAAiC,UAACC,IAAD,EAAU;AACzC,gBAAMmD,QAAQ,CACZ,EAAClD,OAAO,OAAR,EAA+BE,QAAQ,CAAC,MAAD,EAAS,MAAT,EAAiB,MAAjB,CAAvC,EADY,EAEZ,EAACF,OAAO,KAAR,EAA+BE,QAAQ,CAAC,EAAD,EAAK,MAAL,EAAa,EAAb,CAAvC,EAFY,EAGZ,EAACF,OAAO,qBAAR,EAA+BE,QAAQ,CAAC,SAAD,EAAY,WAAZ,EAAyB,MAAzB,CAAvC,EAHY,EAIZ,EAACF,OAAO,UAAR,EAA+BE,QAAQ,CAAC,OAAD,EAAU,MAAV,EAAkB,EAAlB,CAAvC,EAJY,CAAd;;AADyC;AAAA;AAAA;;AAAA;AAQzC,oCAAmBgD,KAAnB,mIAA0B;AAAA,oBAAfC,IAAe;;AACxBtF,oBAAIoB,EAAJ,CAAOmE,eAAP,CAAuBD,KAAKnD,KAA5B;AACAE,uBAAOrC,IAAIoB,EAAJ,CAAO6B,MAAP,CAAckC,OAArB,EAA8BK,cAA9B,CAA6CF,KAAKjD,MAAL,CAAY,CAAZ,CAA7C,EAA6DiD,KAAKjD,MAAL,CAAY,CAAZ,CAA7D,EAA6EiD,KAAKjD,MAAL,CAAY,CAAZ,CAA7E;AACArC,oBAAIoB,EAAJ,CAAO6B,MAAP,CAAckC,OAAd,CAAsBnC,SAAtB;AACD;AAZwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAazCd;AACD,WAdD;;AAgBAD,aAAG,qBAAH,EAA0B,UAACC,IAAD,EAAU;AAClC,gBAAMmD,QAAQ,CACZ,EAAClD,OAAO,SAAR,EAAiCE,QAAQ,CAAC,MAAD,EAAS,MAAT,EAAiB,EAAjB,EAAqB,MAArB,CAAzC,EADY,EAEZ,EAACF,OAAO,QAAR,EAAiCE,QAAQ,CAAC,EAAD,EAAK,MAAL,EAAa,EAAb,EAAiB,MAAjB,CAAzC,EAFY,EAGZ,EAACF,OAAO,uBAAR,EAAiCE,QAAQ,CAAC,SAAD,EAAY,WAAZ,EAAyB,EAAzB,EAA6B,MAA7B,CAAzC,EAHY,EAIZ,EAACF,OAAO,eAAR,EAAiCE,QAAQ,CAAC,OAAD,EAAU,MAAV,EAAkB,KAAlB,EAAyB,MAAzB,CAAzC,EAJY,CAAd;;AADkC;AAAA;AAAA;;AAAA;AAQlC,oCAAmBgD,KAAnB,mIAA0B;AAAA,oBAAfC,IAAe;;AACxBtF,oBAAIoB,EAAJ,CAAOmE,eAAP,CAAuBD,KAAKnD,KAA5B;AACAE,uBAAOrC,IAAIoB,EAAJ,CAAO6B,MAAP,CAAcmC,QAArB,EACGI,cADH,CACkBF,KAAKjD,MAAL,CAAY,CAAZ,CADlB,EACkCiD,KAAKjD,MAAL,CAAY,CAAZ,CADlC,EACkDiD,KAAKjD,MAAL,CAAY,CAAZ,CADlD,EACkEiD,KAAKjD,MAAL,CAAY,CAAZ,CADlE;AAEArC,oBAAIoB,EAAJ,CAAO6B,MAAP,CAAcmC,QAAd,CAAuBpC,SAAvB;AACD;AAbiC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAclCd;AACD,WAfD;;AAiBAD,aAAG,4CAAH,EAAiD,UAACC,IAAD,EAAU;AACzD,gBAAIC,QAAQ,KAAZ;;AAEAnC,gBAAIoB,EAAJ,CAAOmE,eAAP,CAAuBpD,KAAvB;AACAE,mBAAOrC,IAAIoB,EAAJ,CAAO6B,MAAP,CAAciC,QAArB,EAA+BM,cAA/B,CAA8C,MAA9C,EAAsD,MAAtD;AACAtD;AACD,WAND;AAOD,SAnFD;;AAqFAnC,iBAAS,sBAAT,EAAiC,YAAM;AACrC,cAAIwB,UAAU,EAAd;;AAEAtB,qBAAW,YAAM;AACfD,gBAAIoB,EAAJ,CAAOC,mBAAP,GAA6B,UAACC,GAAD;AAAA,qBAASA,GAAT;AAAA,aAA7B;;AAEA,gBAAImE,cAAc,CAAC;AACjB,wBAAU,GADO;AAEjB,sBAAQ,WAFS;AAGjB,sBAAQ,UAHS;AAIjB,4BAAc,GAJG;AAKjB,wBAAU,OALO;AAMjB,wBAAU,GANO;AAOjB,uBAAS,GAPQ;AAQjB,uBAAS,CAAC,EAAC,UAAU,OAAX,EAAoB,QAAQ,WAA5B,EAAD,CARQ;AASjB,sBAAQ;AATS,aAAD,CAAlB;AAWAzF,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAcU,kBAAd,GAAmC7C,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgBmC,WAAhB,CAA1B,CAAnC;;AAEAlE,sBAAU;AACR,yBAAW,EADH;AAER,yBAAW,CAAC;AACV,+BAAe,EAAC,UAAU,EAAX,EADL;AAEV,yBAAS,EAAC,UAAU,YAAX,EAFC;AAGV,wBAAQ,EAAC,UAAU,WAAX,EAHE;AAIV,wBAAQ,EAAC,UAAU,WAAX;AAJE,eAAD;AAFH,aAAV;AASD,WAzBD;;AA2BAU,aAAG,gEAAH,EAAqE,YAAM;;AAEzE,gBAAIyD,eAAe,CAAC;AAClB,2BAAa,OADK;AAElB,0BAAY,GAFM;AAGlB,4BAAc;AAHI,aAAD,CAAnB;;AAMA1F,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAc0C,SAAd,GAA0B7E,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgBoC,YAAhB,CAA1B,CAA1B;;AAEA,mBAAO1F,IAAIoB,EAAJ,CAAOwE,UAAP,CAAkBrE,OAAlB,EACJa,IADI,CACC,gBAAQ;AACZC,qBAAOwD,KAAKC,UAAZ,EAAwBC,YAAxB,CAAqC,CAArC;AACA1D,qBAAOwD,KAAKC,UAAL,CAAgB,CAAhB,CAAP,EAA2BrD,IAA3B,CAAgC,GAAhC;AACA,qBAAOoD,IAAP;AACD,aALI,CAAP;AAMD,WAhBD;;AAkBA5D,aAAG,yEAAH,EAA8E,YAAM;;AAElF,gBAAIyD,eAAe,CAAC;AAClB,2BAAa,OADK;AAElB,0BAAY,GAFM;AAGlB,4BAAc;AAHI,aAAD,CAAnB;;AAMA1F,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAc0C,SAAd,GAA0B7E,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgBoC,YAAhB,CAA1B,CAA1B;;AAEA,mBAAO1F,IAAIoB,EAAJ,CAAOwE,UAAP,CAAkBrE,OAAlB,EACJa,IADI,CACC,gBAAQ;AACZC,qBAAOwD,KAAKC,UAAL,CAAgBtD,MAAvB,EAA+BC,IAA/B,CAAoC,CAApC;AACAJ,qBAAOwD,KAAKC,UAAL,CAAgB,CAAhB,CAAP,EAA2BrD,IAA3B,CAAgC,GAAhC;AACA,qBAAOoD,IAAP;AACD,aALI,CAAP;AAMD,WAhBD;;AAkBA5D,aAAG,4EAAH,EAAiF,YAAM;;AAErF,gBAAIyD,eAAe,CAAC;AAClB,2BAAa,OADK;AAElB,0BAAY,GAFM;AAGlB,4BAAc;AAHI,aAAD,CAAnB;;AAMA1F,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAc0C,SAAd,GAA0B7E,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgBoC,YAAhB,CAA1B,CAA1B;;AAEA,mBAAO1F,IAAIoB,EAAJ,CAAOwE,UAAP,CAAkBrE,OAAlB,EACJa,IADI,CACC,gBAAQ;AACZC,qBAAOwD,KAAKC,UAAL,CAAgBtD,MAAvB,EAA+BC,IAA/B,CAAoC,CAApC;AACAJ,qBAAOwD,KAAKC,UAAL,CAAgB,CAAhB,CAAP,EAA2BrD,IAA3B,CAAgC,EAAhC;AACA,qBAAOoD,IAAP;AACD,aALI,CAAP;AAMD,WAhBD;;AAkBA5D,aAAG,4DAAH,EAAiE,YAAM;;AAErE,gBAAIyD,eAAe,CAAC;AAClB,2BAAa,OADK;AAElB,0BAAY,GAFM;AAGlB,4BAAc;AAHI,aAAD,CAAnB;;AAMA1F,gBAAIoB,EAAJ,CAAO6B,MAAP,CAAc0C,SAAd,GAA0B7E,KAAKC,EAAL,GAAUqC,eAAV,CAA0BC,QAAQC,OAAR,CAAgBoC,YAAhB,CAA1B,CAA1B;;AAEA,mBAAO1F,IAAIoB,EAAJ,CAAOwE,UAAP,CAAkBrE,OAAlB,EACJa,IADI,CACC,gBAAQ;AACZC,qBAAOwD,KAAKC,UAAL,CAAgBtD,MAAvB,EAA+BC,IAA/B,CAAoC,CAApC;AACAJ,qBAAOwD,KAAKC,UAAL,CAAgB,CAAhB,CAAP,EAA2BrD,IAA3B,CAAgC,EAAhC;AACA,qBAAOoD,IAAP;AACD,aALI,CAAP;AAMD,WAhBD;AAiBD,SArGD;AAsGD,OApaD","file":"datasource.spec.js","sourcesContent":["import _ from 'lodash';\nimport { Datasource } from \"../module\";\nimport { zabbixTemplateFormat } from \"../datasource\";\n\ndescribe('ZabbixDatasource', () => {\n  let ctx = {};\n\n  beforeEach(() => {\n    ctx.instanceSettings = {\n      jsonData: {\n        alerting: false,\n        username: 'zabbix',\n        password: 'zabbix',\n        trends: true,\n        trendsFrom: '14d',\n        trendsRange: '7d',\n        dbConnectionEnable: false\n      }\n    };\n    ctx.templateSrv = {};\n    ctx.backendSrv = {\n      datasourceRequest: jest.fn()\n    };\n    ctx.datasourceSrv = {};\n    ctx.zabbixAlertingSrv = {\n      setPanelAlertState: jest.fn(),\n      removeZabbixThreshold: jest.fn(),\n    };\n\n    ctx.ds = new Datasource(ctx.instanceSettings, ctx.templateSrv, ctx.backendSrv, ctx.datasourceSrv, ctx.zabbixAlertingSrv);\n  });\n\n  describe('When querying data', () => {\n    beforeEach(() => {\n      ctx.ds.replaceTemplateVars = (str) => str;\n    });\n\n    ctx.options = {\n      targets: [\n        {\n          group: {filter: \"\"},\n          host: {filter: \"\"},\n          application: {filter: \"\"},\n          item: {filter: \"\"}\n        }\n      ],\n      range: {from: 'now-7d', to: 'now'}\n    };\n\n    it('should return an empty array when no targets are set', (done) => {\n      let options = {\n        targets: [],\n        range: {from: 'now-6h', to: 'now'}\n      };\n      ctx.ds.query(options).then(result => {\n        expect(result.data.length).toBe(0);\n        done();\n      });\n    });\n\n    it('should use trends if it enabled and time more than trendsFrom', (done) => {\n      let ranges = ['now-7d', 'now-168h', 'now-1M', 'now-1y'];\n\n      _.forEach(ranges, range => {\n        ctx.options.range.from = range;\n        ctx.ds.queryNumericData = jest.fn();\n        ctx.ds.query(ctx.options);\n\n        // Check that useTrends options is true\n        let callArgs = ctx.ds.queryNumericData.mock.calls[0];\n        expect(callArgs[2]).toBe(true);\n        ctx.ds.queryNumericData.mockClear();\n      });\n\n      done();\n    });\n\n    it('shouldnt use trends if it enabled and time less than trendsFrom', (done) => {\n      let ranges = ['now-6d', 'now-167h', 'now-1h', 'now-30m', 'now-30s'];\n\n      _.forEach(ranges, range => {\n        ctx.options.range.from = range;\n        ctx.ds.queryNumericData = jest.fn();\n        ctx.ds.query(ctx.options);\n\n        // Check that useTrends options is false\n        let callArgs = ctx.ds.queryNumericData.mock.calls[0];\n        expect(callArgs[2]).toBe(false);\n        ctx.ds.queryNumericData.mockClear();\n      });\n      done();\n    });\n\n  });\n\n  describe('When querying text data', () => {\n    beforeEach(() => {\n      ctx.ds.replaceTemplateVars = (str) => str;\n      ctx.ds.zabbix.zabbixAPI.getHistory = jest.fn().mockReturnValue(Promise.resolve([\n        {clock: \"1500010200\", itemid:\"10100\", ns:\"900111000\", value:\"Linux first\"},\n        {clock: \"1500010300\", itemid:\"10100\", ns:\"900111000\", value:\"Linux 2nd\"},\n        {clock: \"1500010400\", itemid:\"10100\", ns:\"900111000\", value:\"Linux last\"}\n      ]));\n\n      ctx.ds.zabbix.getItemsFromTarget = jest.fn().mockReturnValue(Promise.resolve([\n        {\n          hosts: [{hostid: \"10001\", name: \"Zabbix server\"}],\n          itemid: \"10100\",\n          name: \"System information\",\n          key_: \"system.uname\",\n        }\n      ]));\n\n      ctx.options = {\n        range: {from: 'now-1h', to: 'now'},\n        targets: [\n          {\n            group: {filter: \"\"},\n            host: {filter: \"Zabbix server\"},\n            application: {filter: \"\"},\n            item: {filter: \"System information\"},\n            textFilter: \"\",\n            useCaptureGroups: true,\n            mode: 2,\n            resultFormat: \"table\",\n            options: {\n              skipEmptyValues: false\n            }\n          }\n        ],\n      };\n    });\n\n    it('should return data in table format', (done) => {\n      ctx.ds.query(ctx.options).then(result => {\n        expect(result.data.length).toBe(1);\n\n        let tableData = result.data[0];\n        expect(tableData.columns).toEqual([\n          {text: 'Host'}, {text: 'Item'}, {text: 'Key'}, {text: 'Last value'}\n        ]);\n        expect(tableData.rows).toEqual([\n          ['Zabbix server', 'System information', 'system.uname', 'Linux last']\n        ]);\n        done();\n      });\n    });\n\n    it('should extract value if regex with capture group is used', (done) => {\n      ctx.options.targets[0].textFilter = \"Linux (.*)\";\n      ctx.ds.query(ctx.options).then(result => {\n        let tableData = result.data[0];\n        expect(tableData.rows[0][3]).toEqual('last');\n        done();\n      });\n    });\n\n    it('should skip item when last value is empty', () => {\n      ctx.ds.zabbix.getItemsFromTarget = jest.fn().mockReturnValue(Promise.resolve([\n        {\n          hosts: [{hostid: \"10001\", name: \"Zabbix server\"}],\n          itemid: \"10100\", name: \"System information\", key_: \"system.uname\"\n        },\n        {\n          hosts: [{hostid: \"10002\", name: \"Server02\"}],\n          itemid: \"90109\", name: \"System information\", key_: \"system.uname\"\n        }\n      ]));\n\n      ctx.options.targets[0].options.skipEmptyValues = true;\n      ctx.ds.zabbix.getHistory = jest.fn().mockReturnValue(Promise.resolve([\n          {clock: \"1500010200\", itemid:\"10100\", ns:\"900111000\", value:\"Linux first\"},\n          {clock: \"1500010300\", itemid:\"10100\", ns:\"900111000\", value:\"Linux 2nd\"},\n          {clock: \"1500010400\", itemid:\"10100\", ns:\"900111000\", value:\"Linux last\"},\n          {clock: \"1500010200\", itemid:\"90109\", ns:\"900111000\", value:\"Non empty value\"},\n          {clock: \"1500010500\", itemid:\"90109\", ns:\"900111000\", value:\"\"}\n      ]));\n      return ctx.ds.query(ctx.options).then(result => {\n        let tableData = result.data[0];\n        expect(tableData.rows.length).toBe(1);\n        expect(tableData.rows[0][3]).toEqual('Linux last');\n      });\n    });\n  });\n\n  describe('When replacing template variables', () => {\n\n    function testReplacingVariable(target, varValue, expectedResult, done) {\n      ctx.ds.templateSrv.replace = () => {\n        return zabbixTemplateFormat(varValue);\n      };\n\n      let result = ctx.ds.replaceTemplateVars(target);\n      expect(result).toBe(expectedResult);\n      done();\n    }\n\n    /*\n     * Alphanumerics, spaces, dots, dashes and underscores\n     * are allowed in Zabbix host name.\n     * 'AaBbCc0123 .-_'\n     */\n    it('should return properly escaped regex', (done) => {\n      let target = '$host';\n      let template_var_value = 'AaBbCc0123 .-_';\n      let expected_result = '/^AaBbCc0123 \\\\.-_$/';\n\n      testReplacingVariable(target, template_var_value, expected_result, done);\n    });\n\n    /*\n     * Single-value variable\n     * $host = backend01\n     * $host => /^backend01|backend01$/\n     */\n    it('should return proper regex for single value', (done) => {\n      let target = '$host';\n      let template_var_value = 'backend01';\n      let expected_result = '/^backend01$/';\n\n      testReplacingVariable(target, template_var_value, expected_result, done);\n    });\n\n    /*\n     * Multi-value variable\n     * $host = [backend01, backend02]\n     * $host => /^(backend01|backend01)$/\n     */\n    it('should return proper regex for multi-value', (done) => {\n      let target = '$host';\n      let template_var_value = ['backend01', 'backend02'];\n      let expected_result = '/^(backend01|backend02)$/';\n\n      testReplacingVariable(target, template_var_value, expected_result, done);\n    });\n  });\n\n  describe('When invoking metricFindQuery()', () => {\n    beforeEach(() => {\n      ctx.ds.replaceTemplateVars = (str) => str;\n      ctx.ds.zabbix = {\n        getGroups: jest.fn().mockReturnValue(Promise.resolve([])),\n        getHosts: jest.fn().mockReturnValue(Promise.resolve([])),\n        getApps: jest.fn().mockReturnValue(Promise.resolve([])),\n        getItems: jest.fn().mockReturnValue(Promise.resolve([]))\n      };\n    });\n\n    it('should return groups', (done) => {\n      const tests = [\n        {query: '*',        expect: '/.*/'},\n        {query: '',         expect: ''},\n        {query: 'Backend',  expect: 'Backend'},\n        {query: 'Back*',    expect: 'Back*'},\n      ];\n\n      for (const test of tests) {\n        ctx.ds.metricFindQuery(test.query);\n        expect(ctx.ds.zabbix.getGroups).toBeCalledWith(test.expect);\n        ctx.ds.zabbix.getGroups.mockClear();\n      }\n      done();\n    });\n\n    it('should return hosts', (done) => {\n      const tests = [\n        {query: '*.*',       expect: ['/.*/', '/.*/']},\n        {query: '.',         expect: ['', '']},\n        {query: 'Backend.*', expect: ['Backend', '/.*/']},\n        {query: 'Back*.',    expect: ['Back*', '']},\n      ];\n\n      for (const test of tests) {\n        ctx.ds.metricFindQuery(test.query);\n        expect(ctx.ds.zabbix.getHosts).toBeCalledWith(test.expect[0], test.expect[1]);\n        ctx.ds.zabbix.getHosts.mockClear();\n      }\n      done();\n    });\n\n    it('should return applications', (done) => {\n      const tests = [\n        {query: '*.*.*',               expect: ['/.*/', '/.*/', '/.*/']},\n        {query: '.*.',                 expect: ['', '/.*/', '']},\n        {query: 'Backend.backend01.*', expect: ['Backend', 'backend01', '/.*/']},\n        {query: 'Back*.*.',            expect: ['Back*', '/.*/', '']}\n      ];\n\n      for (const test of tests) {\n        ctx.ds.metricFindQuery(test.query);\n        expect(ctx.ds.zabbix.getApps).toBeCalledWith(test.expect[0], test.expect[1], test.expect[2]);\n        ctx.ds.zabbix.getApps.mockClear();\n      }\n      done();\n    });\n\n    it('should return items', (done) => {\n      const tests = [\n        {query: '*.*.*.*',               expect: ['/.*/', '/.*/', '', '/.*/']},\n        {query: '.*.*.*',                expect: ['', '/.*/', '', '/.*/']},\n        {query: 'Backend.backend01.*.*', expect: ['Backend', 'backend01', '', '/.*/']},\n        {query: 'Back*.*.cpu.*',         expect: ['Back*', '/.*/', 'cpu', '/.*/']}\n      ];\n\n      for (const test of tests) {\n        ctx.ds.metricFindQuery(test.query);\n        expect(ctx.ds.zabbix.getItems)\n          .toBeCalledWith(test.expect[0], test.expect[1], test.expect[2], test.expect[3]);\n        ctx.ds.zabbix.getItems.mockClear();\n      }\n      done();\n    });\n\n    it('should invoke method with proper arguments', (done) => {\n      let query = '*.*';\n\n      ctx.ds.metricFindQuery(query);\n      expect(ctx.ds.zabbix.getHosts).toBeCalledWith('/.*/', '/.*/');\n      done();\n    });\n  });\n\n  describe('When querying alerts', () => {\n    let options = {};\n\n    beforeEach(() => {\n      ctx.ds.replaceTemplateVars = (str) => str;\n\n      let targetItems = [{\n        \"itemid\": \"1\",\n        \"name\": \"test item\",\n        \"key_\": \"test.key\",\n        \"value_type\": \"3\",\n        \"hostid\": \"10631\",\n        \"status\": \"0\",\n        \"state\": \"0\",\n        \"hosts\": [{\"hostid\": \"10631\", \"name\": \"Test host\"}],\n        \"item\": \"Test item\"\n      }];\n      ctx.ds.zabbix.getItemsFromTarget = jest.fn().mockReturnValue(Promise.resolve(targetItems));\n\n      options = {\n        \"panelId\": 10,\n        \"targets\": [{\n          \"application\": {\"filter\": \"\"},\n          \"group\": {\"filter\": \"Test group\"},\n          \"host\": {\"filter\": \"Test host\"},\n          \"item\": {\"filter\": \"Test item\"},\n        }]\n      };\n    });\n\n    it('should return threshold when comparative symbol is `less than`', () => {\n\n      let itemTriggers = [{\n        \"triggerid\": \"15383\",\n        \"priority\": \"4\",\n        \"expression\": \"{15915}<100\",\n      }];\n\n      ctx.ds.zabbix.getAlerts = jest.fn().mockReturnValue(Promise.resolve(itemTriggers));\n\n      return ctx.ds.alertQuery(options)\n        .then(resp => {\n          expect(resp.thresholds).toHaveLength(1);\n          expect(resp.thresholds[0]).toBe(100);\n          return resp;\n        });\n    });\n\n    it('should return threshold when comparative symbol is `less than or equal`', () => {\n\n      let itemTriggers = [{\n        \"triggerid\": \"15383\",\n        \"priority\": \"4\",\n        \"expression\": \"{15915}<=100\",\n      }];\n\n      ctx.ds.zabbix.getAlerts = jest.fn().mockReturnValue(Promise.resolve(itemTriggers));\n\n      return ctx.ds.alertQuery(options)\n        .then(resp => {\n          expect(resp.thresholds.length).toBe(1);\n          expect(resp.thresholds[0]).toBe(100);\n          return resp;\n        });\n    });\n\n    it('should return threshold when comparative symbol is `greater than or equal`', () => {\n\n      let itemTriggers = [{\n        \"triggerid\": \"15383\",\n        \"priority\": \"4\",\n        \"expression\": \"{15915}>=30\",\n      }];\n\n      ctx.ds.zabbix.getAlerts = jest.fn().mockReturnValue(Promise.resolve(itemTriggers));\n\n      return ctx.ds.alertQuery(options)\n        .then(resp => {\n          expect(resp.thresholds.length).toBe(1);\n          expect(resp.thresholds[0]).toBe(30);\n          return resp;\n        });\n    });\n\n    it('should return threshold when comparative symbol is `equal`', () => {\n\n      let itemTriggers = [{\n        \"triggerid\": \"15383\",\n        \"priority\": \"4\",\n        \"expression\": \"{15915}=50\",\n      }];\n\n      ctx.ds.zabbix.getAlerts = jest.fn().mockReturnValue(Promise.resolve(itemTriggers));\n\n      return ctx.ds.alertQuery(options)\n        .then(resp => {\n          expect(resp.thresholds.length).toBe(1);\n          expect(resp.thresholds[0]).toBe(50);\n          return resp;\n        });\n    });\n  });\n});\n"]}